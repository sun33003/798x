name: Build JCG Q30 Pro - SSR Plus Full Protocol

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  CONFIG_FILE: jcg_q30pro_ssrplus_full.config
  TZ: Asia/Shanghai
  UPLOAD_RELEASE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget curl build-essential gawk g++ \
            flex bison gettext libncurses5-dev libssl-dev unzip python3 file

      - name: Clone ImmortalWrt
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt

      - name: Update Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load Custom .config
        run: |
          cd openwrt
          rm -f .config
          cp ../jcg_q30pro_ssrplus_full.config .config
          make defconfig

      - name: Download Packages
        run: |
          cd openwrt
          make download -j8

      - name: Build Firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Package Output
        run: |
          mkdir -p output
          cp -rf openwrt/bin/targets/*/*/* output/ || true

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: env.UPLOAD_RELEASE == 'true'
        with:
          tag_name: Q30Pro-SSRPlus-$(date +'%Y%m%d')
          name: JCG Q30 Pro SSR Plus 全协议固件
          body: |
            ✔ 设备：JCG Q30 Pro（MT7981）
            ✔ 含全协议 SSR Plus（Reality/Hysteria2/TUIC/VMess/VLESS）
            ✔ 已启用 WiFi 完整驱动
          files: output/*
